<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          file:// scheme is now not allowed to be attached with Intent on targetSdkVersion 24 - fancy的博客 | fancy&#39;s Blog
        
    </title>

    <link rel="canonical" href="http://fancychendong.github.io/2016/11/05/scheme is now not allowed to be attached with Intent on targetSdkVersion 24 (Android Nougat). And here is the solution/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">fancychendong&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://fancychendong.github.io/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#android" title="android">android</a>
                        
                    </div>
                    <h1>file:// scheme is now not allowed to be attached with Intent on targetSdkVersion 24</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by xiaodong Chen on
                        2016-11-05
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>@(【每日英文博客】)</p>
<p>#file:// scheme is now not allowed to be attached with Intent on targetSdkVersion 24 (Android Nougat). And here is the solution.<br>Posted on 23 Jul 2016 15:11 | 1291 reads | 0 shares</p>
<p>链接地址：<a href="https://inthecheesefactory.com/blog/how-to-share-access-to-file-with-fileprovider-on-android-nougat/en" target="_blank" rel="external">https://inthecheesefactory.com/blog/how-to-share-access-to-file-with-fileprovider-on-android-nougat/en</a></p>
<p>Android Nougat is almost be publicly released. And as an Android developer, we need to prepare ourself to adjust <strong>targetSdkVersion</strong> to the latest one, <u>24</u>, to let everything works perfectly on the newest release of Android.</p>
<p>And as always, everytime we adjust targetSdkVersion, we need to check and make sure that every single part of our code works perfectly fine. If you just simply change the number, I could say that your application is taking a high risk of crashing or malfunction. In this case, when you change your app’s targetSdkVersion to 24, we need to check that every single function works flawlessly on Android Nougat (24).</p>
<p>And this is one of the checklist you need to mark done before releasing your new version. There is one big security change on Android N like quoted below:</p>
<blockquote>
<p>Passing <code>file://</code> URIs outside the package domain may leave the receiver with an unaccessible path. Therefore, attempts to pass a <code>file://</code> URI trigger a <code>FileUriExposedException</code>. The recommended way to share the content of a private file is using the FileProvider.<br>Summarily, <code>file://</code> is not allowed to attach with Intent anymore or it will throw <code>FileUriExposedException</code> which may cause your app crash immediately called.</p>
</blockquote>
<p>This blog will talk about this issue and also about the solution how to make it work on Android N.</p>
<p>##Real example with a crashing problem<br>You may be curious which situation that can really cause the problem. So to make it be easy to you all, let me show you a real usage example that causes crashing. <strong>The easiest example is the way we take a photo through Intent with</strong> <u><code>ACTION_IMAGE_CAPTURE</code></u> <strong>type</strong>. Previously we just pass the target file path with <code>file://</code>  format as an Intent extra which works fine on Android Pre-N but will just simply crash on Android N and above.</p>
<p>Here is the code. Please note that you can find and download it from <u><a href="https://github.com/nuuneoi/Lab-Intent-FileProvider" target="_blank" rel="external">GitHub</a></u>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line">RuntimePermissions</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_TAKE_PHOTO = <span class="number">1</span>;</div><div class="line"></div><div class="line">    Button btnTakePhoto;</div><div class="line">    ImageView ivPreview;</div><div class="line"></div><div class="line">    String mCurrentPhotoPath;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        initInstances();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initInstances</span><span class="params">()</span> </span>&#123;</div><div class="line">        btnTakePhoto = (Button) findViewById(R.id.btnTakePhoto);</div><div class="line">        ivPreview = (ImageView) findViewById(R.id.ivPreview);</div><div class="line"></div><div class="line">        btnTakePhoto.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/////////////////////</span></div><div class="line">    <span class="comment">// OnClickListener //</span></div><div class="line">    <span class="comment">/////////////////////</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (view == btnTakePhoto) &#123;</div><div class="line">            MainActivityPermissionsDispatcher.startCameraWithCheck(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">////////////</span></div><div class="line">    <span class="comment">// Camera //</span></div><div class="line">    <span class="comment">////////////</span></div><div class="line"></div><div class="line">    <span class="meta">@NeedsPermission</span>(Manifest.permission.WRITE_EXTERNAL_STORAGE)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startCamera</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            dispatchTakePictureIntent();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnShowRationale</span>(Manifest.permission.WRITE_EXTERNAL_STORAGE)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showRationaleForCamera</span><span class="params">(<span class="keyword">final</span> PermissionRequest request)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</div><div class="line">                .setMessage(<span class="string">"Access to External Storage is required"</span>)</div><div class="line">                .setPositiveButton(<span class="string">"Allow"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">                        request.proceed();</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .setNegativeButton(<span class="string">"Deny"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">                        request.cancel();</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</div><div class="line">        <span class="keyword">if</span> (requestCode == REQUEST_TAKE_PHOTO &amp;&amp; resultCode == RESULT_OK) &#123;</div><div class="line">            <span class="comment">// Show the thumbnail on ImageView</span></div><div class="line">            Uri imageUri = Uri.parse(mCurrentPhotoPath);</div><div class="line">            File file = <span class="keyword">new</span> File(imageUri.getPath());</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                InputStream ims = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">                ivPreview.setImageBitmap(BitmapFactory.decodeStream(ims));</div><div class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// ScanFile so it will be appeared on Gallery</span></div><div class="line">            MediaScannerConnection.scanFile(MainActivity.<span class="keyword">this</span>,</div><div class="line">                    <span class="keyword">new</span> String[]&#123;imageUri.getPath()&#125;, <span class="keyword">null</span>,</div><div class="line">                    <span class="keyword">new</span> MediaScannerConnection.OnScanCompletedListener() &#123;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScanCompleted</span><span class="params">(String path, Uri uri)</span> </span>&#123;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions, <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        MainActivityPermissionsDispatcher.onRequestPermissionsResult(<span class="keyword">this</span>, requestCode, grantResults);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> File <span class="title">createImageFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// Create an image file name</span></div><div class="line">        String timeStamp = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd_HHmmss"</span>).format(<span class="keyword">new</span> Date());</div><div class="line">        String imageFileName = <span class="string">"JPEG_"</span> + timeStamp + <span class="string">"_"</span>;</div><div class="line">        File storageDir = <span class="keyword">new</span> File(Environment.getExternalStoragePublicDirectory(</div><div class="line">                Environment.DIRECTORY_DCIM), <span class="string">"Camera"</span>);</div><div class="line">        File image = File.createTempFile(</div><div class="line">                imageFileName,  <span class="comment">/* prefix */</span></div><div class="line">                <span class="string">".jpg"</span>,         <span class="comment">/* suffix */</span></div><div class="line">                storageDir      <span class="comment">/* directory */</span></div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="comment">// Save a file: path for use with ACTION_VIEW intents</span></div><div class="line">        mCurrentPhotoPath = <span class="string">"file:"</span> + image.getAbsolutePath();</div><div class="line">        <span class="keyword">return</span> image;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchTakePictureIntent</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Intent takePictureIntent = <span class="keyword">new</span> Intent(MediaStore.ACTION_IMAGE_CAPTURE);</div><div class="line">        <span class="comment">// Ensure that there's a camera activity to handle the intent</span></div><div class="line">        <span class="keyword">if</span> (takePictureIntent.resolveActivity(getPackageManager()) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Create the File where the photo should go</span></div><div class="line">            File photoFile = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                photoFile = createImageFile();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                <span class="comment">// Error occurred while creating the File</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Continue only if the File was successfully created</span></div><div class="line">            <span class="keyword">if</span> (photoFile != <span class="keyword">null</span>) &#123;</div><div class="line">                Uri photoURI = Uri.fromFile(createImageFile());</div><div class="line">                takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, photoURI);</div><div class="line">                startActivityForResult(takePictureIntent, REQUEST_TAKE_PHOTO);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>When code above is run, there will be a Button shown on screen. Once Button is clicked, camera app will be launched to let you take a photo. After everything is done, the taken photo will be shown on the ImageView as a result.</p>
<p><img src="./1470061360945.png" alt="Alt text"><br>What the code does is quite straightforward. Generated file path pointed to DCIM folder under External Storage will be sent to camera app in <code>file://</code> format and will be used as file path of a photo taken.</p>
<p>Code above works fine even on Android Nougat since targetSdkVersion is still be 23. Now let’s change it to 24.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">    defaultConfig &#123;</div><div class="line">        ...</div><div class="line">        targetSdkVersion <span class="number">24</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Here is the result. It still works on Android Pre-N but it appears to cause crashing on Android Nougat like this:<br><img src="./1470061396069.png" alt="Alt text"><br>And here is the stacktrace.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">FATAL EXCEPTION: main</div><div class="line">    Process: com.inthecheesefactory.lab.intent_fileprovider, PID: <span class="number">28905</span></div><div class="line">    android.os.FileUriExposedException: file:<span class="comment">///storage/emulated/0/DCIM/Camera/JPEG_20160723_124304_642070113.jpg exposed beyond app through ClipData.Item.getUri()</span></div><div class="line">    at android.os.StrictMode.onFileUriExposed(StrictMode.java:<span class="number">1799</span>)</div><div class="line">    at android.net.Uri.checkFileUriExposed(Uri.java:<span class="number">2346</span>)</div><div class="line">    at android.content.ClipData.prepareToLeaveProcess(ClipData.java:<span class="number">832</span>)</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>The reason is quite obvious. <code>file://</code> is not allowed as an attached URI in Intent or <code>FileUriExposedException</code> would be thrown.</p>
<p>And this is a big issue that you have to make sure that all code related to this case has already been fixed before releasing a new version with targetSdkVersion 24 or your app may crash on some of your user’s device.</p>
<p>##Why Nougat does not allow passing file:// with Intent anymore?<br>You may be curious why Android team decide to change this behavior. Actually there is a good reason behind.</p>
<p>If file path is sent to the target application (Camera app in this case), file will be fully accessed through the Camera app’s process not the sender one.<br><img src="./1470061475595.png" alt="Alt text"><br>But let’s consider thoroughly, actually Camera is launched by our application to take a photo and save as a file on our app’s behalf. So the access right to that file should be our app’s not Camera’s. Every operation did with the file should be done through our application not by Camera app itself.</p>
<p>And that’s why <code>file://</code> is now prohibited on targetSdkVersion 24 to force every developer to do this task in the proper way.</p>
<p>##Solution<br>So if <code>file://</code> is not allowed anymore, which approach should we go for? The answer is we should send the URI through <code>content://</code> scheme instead which is the URI scheme for Content Provider. In this case, we would like to share an access to a file through our app so <code>FileProvider</code> is needed to be implemented. Flow is now changed like below:<br><img src="./1470061533635.png" alt="Alt text"><br>And now, with FileProvider, file operation would be done through our app process like it supposes to be !</p>
<p>It is quite easy to implement FileProvider on your application. First you need to add a FileProvider <code>&lt;provider&gt;</code> tag in <code>AndroidManifest.xml</code> under <code>&lt;application&gt;</code> tag like below:</p>
<p>AndroidManifest.xml<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"</div><div class="line">    ...</div><div class="line">    &lt;application</div><div class="line">        ...</div><div class="line">        &lt;provider</div><div class="line">            android:name="android.support.v4.content.FileProvider"</div><div class="line">            android:authorities="$&#123;applicationId&#125;.provider"</div><div class="line">            android:exported="false"</div><div class="line">            android:grantUriPermissions="true"&gt;</div><div class="line">            &lt;meta-data</div><div class="line">                android:name="android.support.FILE_PROVIDER_PATHS"</div><div class="line">                android:resource="@xml/provider_paths"/&gt;</div><div class="line">        &lt;/provider&gt;</div><div class="line">    &lt;/application&gt;</div><div class="line">&lt;/manifest&gt;</div></pre></td></tr></table></figure></p>
<p>And then create a <code>provider_paths.xml</code> file in <code>xml</code> folder under <code>res</code> folder. Folder may be needed to create if it doesn’t exist.</p>
<p>The content of the file is shown below. It describes that we would like to share access to the External Storage at root folder <strong>(path=”.”)</strong> with the name <strong>external_files</strong>.</p>
<p><strong>res/xml/provider_paths.xml</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">&lt;paths xmlns:android="http://schemas.android.com/apk/res/android"&gt;</div><div class="line">    &lt;external-path name="external_files" path="."/&gt;</div><div class="line">&lt;/paths&gt;</div></pre></td></tr></table></figure></p>
<p>Done! FileProvider is now declared and be ready to use.</p>
<p>The final step is to change the line of code below in <strong>MainActivity.java</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Uri photoURI = Uri.fromFile(createImageFile());</div></pre></td></tr></table></figure></p>
<p>to<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Uri photoURI = FileProvider.getUriForFile(MainActivity.<span class="keyword">this</span>,</div><div class="line">        BuildConfig.APPLICATION_ID + <span class="string">".provider"</span>,</div><div class="line">        createImageFile());</div></pre></td></tr></table></figure></p>
<p>And …. done ! Your application should now work perfectly fine on any Android version including Android Nougat. Yah !<br><img src="./1470061711336.png" alt="Alt text"></p>
<p>##How about the existed app launched previously?<br>As you can see from the experiment result above. This behavior will happen only when you change your app’s targetSdkVersion to 24 or above. So if your previously launched application was set the targetSdkVersion to 23 or lower, it supposes not to be a problem even on Android Nougat. <code>file://</code> should still works perfectly fine.</p>
<p>Anyway, to match the Android Best Practice, when there is a new API Level, we better always change targetSdkVersion to the latest one for the best user experience. =)</p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2016/11/21/Android开发注意事项/" data-toggle="tooltip" data-placement="top" title="Android开发注意事项">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2016/11/05/收集Android错误/" data-toggle="tooltip" data-placement="top" title="收集Android错误">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#android" title="android">android</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>

        </div>
    </div>
</article>









    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; fancychendong&#39;s Blog 2017 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://fancychendong.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="http://fancychendong.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
